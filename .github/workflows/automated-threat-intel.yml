name: Automated Threat Intelligence Pipeline

# Trigger: manual or schedule (twice daily)
on:
  schedule:
    - cron: '0 6,18 * * *'   # 06:00 and 18:00 UTC ~ 1 AM & 1 PM EST
  workflow_dispatch:

jobs:
  threat-intel-pipeline:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Set up Python
      - name: Set up Python 3.13
        uses: actions/setup-python@v4
        with:
          python-version: 3.13

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4️⃣ Run the pipeline
      - name: Run Threat Intelligence Pipeline
        run: |
          python run.py

      # 5️⃣ Update README with timestamp
      - name: Update README last updated timestamp
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          echo "## Last Pipeline Update: $TIMESTAMP" > last_update.md
          # Insert into README.md
          sed -i '/## Last Pipeline Update:/d' README.md
          cat last_update.md >> README.md

      # 6️⃣ Commit and push generated files back to repo
      - name: Commit outputs and build back to repository
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add build/ outputs/ README.md
          git commit -m "Update outputs, build, and README from workflow" || echo "Nothing to commit"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
